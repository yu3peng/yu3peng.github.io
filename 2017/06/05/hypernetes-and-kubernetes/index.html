<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Hypernetes & Kubernetes &mdash; Yu Peng</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/rouge-themes@master/dist/github.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/vendor/share.js/dist/css/share.min.css"><link rel="canonical" href="https://y2p.cc/2017/06/05/hypernetes-and-kubernetes/"><link rel="alternate" type="application/atom+xml" title="Yu Peng" href="https://y2p.cc/feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/favicon.ico"><meta property="og:title" content="Hypernetes & Kubernetes"><meta name="keywords" content="yupeng"><meta name="og:keywords" content="yupeng"><meta name="description" content="本文介绍Hypernetes与Kubernetes之间的关系"><meta name="og:description" content="本文介绍Hypernetes与Kubernetes之间的关系"><meta property="og:url" content="https://y2p.cc/2017/06/05/hypernetes-and-kubernetes/"><meta property="og:site_name" content="Yu Peng"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2017-06-05"> <script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-7093222719567591" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-170170785-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-170170785-1'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://y2p.cc/" title="Yu Peng"><span class="octicon octicon-mark-github"></span> Yu Peng</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://y2p.cc/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://y2p.cc/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://y2p.cc/notes/" class=" site-header-nav-item" target="" title="笔记">笔记</a> <a href="https://y2p.cc/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Hypernetes & Ku"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Hypernetes & Kubernetes</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2017/06/05 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://y2p.cc/categories/#Kubernetes" title="Kubernetes">Kubernetes</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 5532 字，约 16 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>本文介绍Hypernetes与Kubernetes之间的关系</p><p><img src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/images/posts/rethink-of-virtualization-and-containerization-13-638.jpg" alt="rethink-of-virtualization-and-containerization" /></p><h2 id="hypernetes相关链接">Hypernetes相关链接</h2><ol><li><a href="http://sacc.it168.com/PPT2016/%E4%B8%9315-3%EF%BC%8D%E8%A3%B4%E5%BD%A4.pdf">Hypernetes的卖点</a></li><li><a href="https://github.com/hyperhq/hypernetes">github地址</a></li><li><a href="https://www.hyper.sh/">基于 HyperContainer 和 Hypernetes 项目的公有云：Hyper_</a></li><li><a href="https://www.zhihu.com/question/35412725/answer/101715150">知乎话题：如何评价 hyper_</a></li><li><a href="https://www.youtube.com/watch?v=3QTbFS7iLgo">Secure NFV (Clearwater) deployment on Kubernetes (Hypernetes) in 10 min</a></li><li><a href="https://wangxu.me/">项目拥有者博客</a></li><li><a href="https://www.kubernetes.org.cn/239.html">将Hypernetes整合至Kubernetes带来安全性与多租户机制</a></li><li><a href="/assets/pdf/Hypernetes_install_Log.txt">Hypernetes安装日志</a></li></ol><h2 id="hypernetes简介">Hypernetes简介</h2><p>Hypernetes在Kubernetes基础上增加了多租户认证授权、容器SDN网络、基于Hyper的容器执行引擎以及基于Cinder的持久化存储等。</p><p>基本上<strong><em>Hypernetes = Bare-metal + Hyper + Kubernetes + Cinder(Ceph) + Neutron + Keystone</em></strong></p><p>在介绍Hypernetes细节之前先首先提一下相关背景，也就是Kubernetes的多租户支持情况。</p><p>Kubernetes在多租户方面的支持还是比较少的，没有“租户”这一概念，也只有namespace提供了一个逻辑的资源池（可以给这个namespace设定一些资源的配额），并且它在认证授权、网络、Container Runtime等方面离真正的多租户还都比较远。</p><ol><li><p>认证方面，虽然支持client certificates，tokens，http basic auth等，但没有用户管理的功能。如果想要新建用户，需要手动修改配置文件并重启服务。最新版本增加了Keystone的认证，可以借助Keystone来管理用户。</p></li><li><p>授权方面，目前只有AlwaysDeny ，AlwaysAllow以及ABAC模式。ABAC模式根据一个策略文件来配置不同用户的权限，比如限定用户只能访问特定的namespace等，但对于新创建的namespace等资源需要重复修改策略文件。</p></li><li><p>Kubernetes要求cluster内部所有的容器之间是全通的，而多租户情况下需要不同租户之前网络是隔离的。</p></li><li><p>Docker的安全性问题，跟虚拟化还是有不少距离。</p></li></ol><p>正是由于上面这些原因，很多公司都在虚拟机里面来跑Kubernetes，比如Google Container Engine、OpenStack Magnum等。</p><p>在虚拟机内部跑容器虽然提升了安全性，但也引入了一些问题，比如容器的网络不能通过IaaS层来统一管理，容器无法直接使用IaaS层的持久化存储，无法集中调度所有容器的资源等。</p><p>先来看一下Hypernetes的架构图</p><p><img src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/images/posts/hypernetes-orchitecher.png" alt="Hypernetes-orchitecher" /></p><p>Hypernetes在Kubernetes基础上增加了一些组件</p><ol><li><p>增加了Tenant的概念，不同Tenant之间的网络和资源(ns, pod, svc, rc等)是隔离的。这些租户通过keystone管理，并提供认证和授权</p></li><li><p>通过Neutron给不同租户提供二层隔离的网络，并支持Neutron的各种插件（目前主要是ovs）</p></li><li><p>通过Hyper提供基于虚拟化的容器执行引擎，保证容器的隔离</p></li><li><p>还有通过Cinder给容器引入各种持久化存储（目前主要是ceph）</p></li></ol><p>具体到Hypernetes内部，详细的架构是这样的</p><p><img src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/images/posts/hypernetes-orchitecher-1.png" alt="Hypernetes-orchitecher-1" /></p><p>为了支持多租户，Hypernetes基于Kubernetes增加了很多组件，这些组件都是以Plugin的形式提供的。</p><p>这样非常方便扩展，也很容易将Hypernetes与现有的IaaS在同一个基础架构上运行起来</p><p>比如，如果你不喜欢Neutron，可以把它替换成odl等。</p><h2 id="与kubernetes的关系">与Kubernetes的关系</h2><ol><li><p>The hypervisor-based container runtime for Kubernetes，通过Hyper提供基于虚拟化的容器执行引擎，保证容器的隔离，并将其贡献在kubernetes组织下：<a href="https://github.com/kubernetes/frakti">frakti</a>，再通过CRI（Container Runtime Interface），原生接入Kubernetes，类似CoreOS公司的rkt接入kubernetes。 在Hypernetes v1.6版本中，Hypernetes的容器运行时也将从一套名为<a href="https://github.com/hyperhq/runv">runV</a>的OCI标准容器运行时切换到<a href="https://github.com/kubernetes/frakti">frakti</a>。</p></li><li><p>Hypernetes 是从Kubernetes项目中fork出来的。为了支持多租户，Hypernetes基于Kubernetes增加了很多组件，这些组件都是以Plugin的形式提供的。</p></li><li><p>关于虚拟化和容器化的思考，可以参见项目拥有者的一篇报告<a href="https://www.slideshare.net/gnawux/rethink-of-virtualization-and-containerization">Re-Think of Virtualization and Containerization</a></p></li><li><p>Hypernetes 借助Kubernetes中的RBAC（Role-Based Access Control）来实现接入控制，具体方式如下图所示</p></li></ol><p><img src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/images/posts/RBAC.png" alt="RBAC" /></p><p>userA和userB是通过[role_binding1][role1]连接到name space 1，得到在name space1进行操作的权限。userB则是[role_binding2]-&gt;[role2]得到在name space2进行操作的权限。</p><h2 id="proposal-of-hypernetes16-auth">Proposal of hypernetes1.6 auth</h2><ul><li><p>Continue to use keystone, Keystone authentication is enabled by passing the –experimental-keystone-url=<AuthURL> option to the API server during startup</AuthURL></p></li><li><p>Use <a href="https://kubernetes.io/docs/admin/authorization/">RBAC</a> for authorization，enable the authorization module with –authorization-mode=RBAC</p></li><li><p>Add auth-controller to manage RBAC policy</p></li></ul><h2 id="auth-workflow">auth workflow:</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl                 apiserver                keystone               rbac         auth+controller
   +                       +                         +                    +                 +
   |         1             |                         |                    |                 |
   +-----+request+---------&gt;                         |                    |                 |
   |                       |           2             |                    &lt;--+update policy++
   |                       +----+Authentication+-----&gt;                    |                 |
   |                       |           3             |                    |                 |
   |                       &lt;---+user.info,success+---+                    |                 |
   |                       |                      4  +                    |                 |
   |                       +-------------------+Authorization+------------&gt;                 |
   |                       |                     5   +                    |                 |
   |                       &lt;--------------------+success+-----------------+                 |
   |          6            |                         +                    |                 |
   &lt;-----+response+--------+                         |                    |                 |
   |                       |                         |                    |                 |
   +                       +                         +                    +                 +

</code></pre></div></div><ul><li><p>To update rbac policy, auth-controller need to get user-info. Auth-controller update <code class="language-plaintext highlighter-rouge">ClusterRole</code> and <code class="language-plaintext highlighter-rouge">RoleBinding</code> to get permissions of namespaces, when user is updated. May be we should add user as a kind of resource.</p></li><li><p>Watch <code class="language-plaintext highlighter-rouge">Namespace</code> and update the permissions of namespace scoped resources for regular user.</p></li></ul><ol><li>kubectl send request with (username, password) to apiserver</li><li>Apiserver receive request from kubectl, and call <a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/plugin/pkg/authenticator/password/keystone/keystone.go#L42">AuthenticatePassword</a>(username, password) to check (username, password) via keystone.</li><li>If check successfully return (user.info, true), continue to step4. if check fail return (user.info, fales), request fail.</li><li>call <a href="https://github.com/kubernetes/kubernetes/blob/master/plugin/pkg/auth/authorizer/rbac/rbac.go#L70">Authorize</a>(authorizer.Attributes) to check RBAC roles and binding.</li><li>if check success return true and execute operation of the request. if check fail return false ,request fail.</li><li>return request result</li></ol><h2 id="add-user">Add user</h2><ul><li>Use <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/extend-api-third-party-resource/">Third Party Resources</a> to create user resource :</li></ul><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: extensions/v1beta1
kind: ThirdPartyResource
metadata:
  name: user.stable.example.com
description: "A specification of a User"
versions:
- name: v1
</code></pre></div></div><ul><li>Add a user object. May be there more detail user information will be set using custom fields like <code class="language-plaintext highlighter-rouge">username</code>. At least username are required.</li></ul><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: "stable.example.com/v1"
kind: User
metadata:
  name: alice
username: "alice chen"
</code></pre></div></div><h2 id="auth-controller">auth-controller</h2><p>auth-controller is responsible of updating RBAC roles and binding when</p><ul><li>new user is created: allow the user to create/get namespace</li><li>new namespace is created/deleted</li><li>network is created/deleted</li><li>user is removed: delete all user related data</li></ul><p>auth -controller will watch resources including <code class="language-plaintext highlighter-rouge">User</code>, <code class="language-plaintext highlighter-rouge">NameSpace</code>, <code class="language-plaintext highlighter-rouge">Network</code> and update RBAC roles and binding using superuser. First create <code class="language-plaintext highlighter-rouge">ClusterRole</code> for regular user to get permissions of <code class="language-plaintext highlighter-rouge">NameSpace</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1alpha1
metadata:
  # "namespace" omitted since ClusterRoles are not namespaced.
  name: namespace-creater
rules:
  - apiGroups: [""]
    resources: ["namespace"]
    verbs: ["get", "create"] # I think verbs should include "delete"，user have permission of deleting their namespace 
</code></pre></div></div><h3 id="new-user-are-created">new user are created:</h3><p>create <code class="language-plaintext highlighter-rouge">ClusterRoleBinding</code> for new regular user reference <code class="language-plaintext highlighter-rouge">namespace-creater</code> role:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1alpha1
metadata:
  name: username-namespace-creater
subjects:
  - kind: User 
    name: username
roleRef:
  kind: ClusterRole
  name: namespace-creater
  apiGroup: rbac.authorization.k8s.io
</code></pre></div></div><h3 id="a-new-namespace-are-created">a new namespace are created:</h3><p>create <code class="language-plaintext highlighter-rouge">Role</code> namespaced:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kind: Role
apiVersion: rbac.authorization.k8s.io/v1alpha1
metadata:
  namespace: namespace
  name: access-resources-within-namespace
rules:
  - apiGroups: [""]
    resources: [ResourceAll]
    verbs: [VerbAll]
</code></pre></div></div><p>create <code class="language-plaintext highlighter-rouge">Rolebinding</code> reference to <code class="language-plaintext highlighter-rouge">role</code> namespace:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1alpha1
metadata:
  name: namespace-binding
  namespace: namespace 
subjects:
  - kind: User
    name: username
roleRef:
  kind: Role
  name: access-resources-within-namespace
  apiGroup: rbac.authorization.k8s.io
</code></pre></div></div><p>role and rolebinding will be removed when namespace are deleted</p><h3 id="a-network-is-createddeleted">a network is created/deleted</h3><p><code class="language-plaintext highlighter-rouge">Network</code> will be defined non-namespaced resource. we can set permission of <code class="language-plaintext highlighter-rouge">Network</code> in <code class="language-plaintext highlighter-rouge">ClusterRole</code> when user are created.</p><h3 id="a-user-is-deleted">a user is deleted:</h3><p><code class="language-plaintext highlighter-rouge">ClusterRoleBinding</code> related the user will be removed at least.</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://y2p.cc" target="_blank">Yu Peng</a></li><li>本文链接：<a href="https://y2p.cc/2017/06/05/hypernetes-and-kubernetes/" target="_blank">https://y2p.cc/2017/06/05/hypernetes-and-kubernetes/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"><div class="share-component" data-disabled='qq,facebook'></div></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2017/06/05/hypernetes-and-kubernetes/', clientID: 'b2ad054f2e4daf7ad564', clientSecret: 'c742e4086336e58b70e0e88dc791e5bce6e37330', repo: 'blog-comments', owner: 'yu3peng', admin: ['yu3peng'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@built/assets/search_data.json?v=1651828648', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 30, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2022 <span title="Yu Peng">Yu Peng</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/yu3peng/yu3peng.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://y2p.cc/" title="首页" target="">首页</a></li><li> <a href="https://y2p.cc/categories/" title="分类" target="">分类</a></li><li> <a href="https://y2p.cc/notes/" title="笔记" target="">笔记</a></li><li> <a href="https://y2p.cc/about/" title="关于" target="">关于</a></li><li><a href="https://y2p.cc/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/vendor/share.js/dist/js/share.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
