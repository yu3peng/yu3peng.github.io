<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Kubernetes HPA &mdash; Yu Peng</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/rouge-themes@master/dist/github.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/vendor/share.js/dist/css/share.min.css"><link rel="canonical" href="https://y2p.cc/2018/12/20/kubernetes-hpa/"><link rel="alternate" type="application/atom+xml" title="Yu Peng" href="https://y2p.cc/feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/favicon.ico"><meta property="og:title" content="Kubernetes HPA"><meta name="keywords" content="yupeng"><meta name="og:keywords" content="yupeng"><meta name="description" content="Kubernetes HPA"><meta name="og:description" content="Kubernetes HPA"><meta property="og:url" content="https://y2p.cc/2018/12/20/kubernetes-hpa/"><meta property="og:site_name" content="Yu Peng"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2018-12-20"> <script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-7093222719567591" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-170170785-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-170170785-1'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://y2p.cc/" title="Yu Peng"><span class="octicon octicon-mark-github"></span> Yu Peng</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://y2p.cc/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://y2p.cc/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://y2p.cc/notes/" class=" site-header-nav-item" target="" title="笔记">笔记</a> <a href="https://y2p.cc/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Kubernetes HPA"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Kubernetes HPA</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2018/12/20 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://y2p.cc/categories/#Kubernetes" title="Kubernetes">Kubernetes</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 7645 字，约 22 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>Kubernetes HPA</p><h2 id="kubernetes-设计理念">Kubernetes 设计理念</h2><p>用户定义应用程序的规格，Kubernetes 按照定义的规格部署并运行应用程序。</p><p>其实现依赖于 <code class="language-plaintext highlighter-rouge">声明式 API</code>: 就是当用户向 Kubernetes 提交了一个 API 对象的描述之后，Kubernetes 会负责为你保证整个集群里各项资源的状态，都与你的 API 对象描述的需求相一致。更重要的是，这个保证是一项“无条件的”、“没有期限”的承诺：对于每个保存在 etcd 里的 API 对象，Kubernetes 都通过启动一种叫做“控制器模式”（Controller Pattern）的无限循环，不断检查，然后调谐，最后确保整个集群的状态与这个 API 对象的描述一致。</p><div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">{</span>
  <span class="n">实际状态</span> <span class="o">:=</span> <span class="n">获取集群中对象X的实际状态</span><span class="err">（</span><span class="n">Actual</span> <span class="n">State</span><span class="err">）</span>
  <span class="n">期望状态</span> <span class="o">:=</span> <span class="n">获取集群中对象X的期望状态</span><span class="err">（</span><span class="n">Desired</span> <span class="n">State</span><span class="err">）</span>
  <span class="k">if</span> <span class="n">实际状态</span> <span class="o">==</span> <span class="n">期望状态</span><span class="p">{</span>
    <span class="n">什么都不做</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">执行编排动作</span><span class="err">，</span><span class="n">将实际状态调整为期望状态</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="hpa">HPA</h2><p>1、HPA全称Horizontal Pod Autoscaling，即POD的水平自动伸缩。</p><p>Kubernetes 最大的特点是在用户定义的应用程序规格内进行自动伸缩，自动伸缩主要分为两种，其一为POD的水平伸缩，针对于POD数目的增减，也就是HPA；其二为垂直伸缩，即单个POD可以使用的资源的增减，也就是在POD的requests（最小资源）、limits（最大资源）范围内增减资源。</p><p>2、HPA是Kubernetes中实现POD水平自动伸缩的功能。</p><p>云计算具有水平弹性的特性，这是云计算区别于传统IT技术架构的主要特性。对于Kubernetes中的POD来说，HPA可以实现很多自动化功能，比如当POD中业务负载上升的时候，可以创建新的POD来保证业务系统稳定运行，当POD中业务负载下降的时候，可以销毁POD来提高资源利用率。</p><p>3、HPA控制器默认每隔30秒就会运行一次。</p><p>如果要修改间隔时间，可以设置horizontal-pod-autoscaler-sync-period参数。</p><p>4、HPA的操作对象是RC、RS或Deployment对应的POD</p><p>根据观察到的CPU等实际使用量与用户的期望值进行比对，做出是否需要增减POD实例数量的决策。</p><p>5、HPA的发展历程</p><p>在Kubernetes v1.1中首次引入了HPA特性。HPA第一个版本基于观察到的CPU利用率，后续版本支持基于内存使用。</p><p>在Kubernetes 1.6中引入了一个新的API，用来自定义指标，它允许HPA访问任意指标。</p><p>Kubernetes 1.7引入了聚合层，允许第三方应用程序通过注册为API附加组件来扩展Kubernetes API。自定义指标API以及聚合层使得像Prometheus这样的监控系统可以向HPA控制器公开特定于应用程序的指标。</p><h2 id="部署监测工具">部署监测工具</h2><p>因为POD的metrics信息来源于其他第三方监控组件，所以在开始之前要保证监控组件的运行正常，我们拿metrics-server来举例。</p><h3 id="部署metrics-server">部署metrics-server</h3><p>可以按照以下方式部署：</p><p>测量 CPU/Memory HPA ，可以使用 <code class="language-plaintext highlighter-rouge">https://github.com/kubernetes-incubator/metrics-server</code> 中所示方式，如下：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir K8s-monitor
cd K8s-monitor
git clone https://github.com/kubernetes-incubator/metrics-server.git
# 如果 Kubernetes &gt; 1.8
cd metrics-server/deploy/1.8+/
</code></pre></div></div><p>修改 <code class="language-plaintext highlighter-rouge">metrics-server-deployment.yaml</code> 配置，在 <code class="language-plaintext highlighter-rouge">containers</code> 中添加 <code class="language-plaintext highlighter-rouge">command</code> 有关的内容</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      containers:
      - name: metrics-server
        image: k8s.gcr.io/metrics-server-amd64:v0.3.1
        imagePullPolicy: Always
        command:
        - /metrics-server
        - --kubelet-insecure-tls
        - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP
        volumeMounts:
        - name: tmp-dir
          mountPath: /tmp
</code></pre></div></div><p>部署</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply -f ./
</code></pre></div></div><p>验证</p><p>可以通过运行 <code class="language-plaintext highlighter-rouge">kubectl top node</code> 来验证metrics-server是否运行正常。</p><p>运行不正常情况</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl top node
error: metrics not available yet
</code></pre></div></div><p>运行正常情况</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl top node
NAME       CPU(cores)   CPU%      MEMORY(bytes)   MEMORY%
master01   228m         5%        2551Mi          26%
minion01   189m         4%        1991Mi          20%
minion02   138m         3%        1594Mi          16%
minion03   75m          1%        941Mi           9%
</code></pre></div></div><p>提示：刚部署完成后，需要稍等一会才会出现运行正常的情况。</p><h3 id="部署prometheus">部署prometheus</h3><p>可以使用 <code class="language-plaintext highlighter-rouge">https://github.com/coreos/prometheus-operator</code> 中所示方式。</p><h3 id="部署其他监控维度的监测工具">部署其他监控维度的监测工具</h3><p>可以参考 <code class="language-plaintext highlighter-rouge">https://github.com/heptiolabs/eventrouter</code> 中所示方式。</p><h2 id="制作镜像">制作镜像</h2><p>新建文件夹hpa-test-app</p><p>在hpa-test-app文件夹下，新建hpa-test-app.go文件，内容如下：</p><div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
    <span class="s">"log"</span>
    <span class="s">"net/http"</span>
    <span class="s">"strconv"</span>
    <span class="s">"strings"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">compPiHandler</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Server work at :8080 ..."</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8080"</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"ListenAndServe: "</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">compPiHandler</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">var</span> <span class="p">(</span>
        <span class="n">lenI</span> <span class="kt">int</span>
        <span class="n">err</span>  <span class="kt">error</span>
    <span class="p">)</span>

    <span class="n">lenS</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">URL</span><span class="o">.</span><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"length"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lenS</span> <span class="o">!=</span> <span class="s">""</span> <span class="p">{</span>
        <span class="n">lenI</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">lenS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="n">lenI</span> <span class="o">=</span> <span class="m">100</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">lenI</span> <span class="o">=</span> <span class="m">100</span>
    <span class="p">}</span>

    <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">compPi</span><span class="p">(</span><span class="n">lenI</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">compPi</span><span class="p">(</span><span class="n">L</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">Pi</span> <span class="p">[]</span><span class="kt">string</span>

    <span class="n">N</span> <span class="o">:=</span> <span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">/</span><span class="m">4</span> <span class="o">+</span> <span class="m">1</span>

    <span class="n">s</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="m">3</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="m">3</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="m">3</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="m">3</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">:=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="kt">float32</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">/</span><span class="m">1.39793</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>

    <span class="n">w</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">=</span> <span class="m">16</span> <span class="o">*</span> <span class="m">5</span>
    <span class="n">v</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">=</span> <span class="m">4</span> <span class="o">*</span> <span class="m">239</span>

    <span class="k">for</span> <span class="n">k</span> <span class="o">:=</span> <span class="m">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">div</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="m">25</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">div</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="m">57121</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">sub</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">div</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="m">2</span><span class="o">*</span><span class="n">k</span><span class="o">-</span><span class="m">1</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">%</span><span class="m">2</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
            <span class="n">add</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sub</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">Pi</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">Pi</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%d."</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="m">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">k</span> <span class="o">:=</span> <span class="m">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">Pi</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">Pi</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%04d"</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">strings</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">Pi</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">add</span><span class="p">(</span><span class="n">a</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">b</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">c</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">N</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">carry</span> <span class="o">:=</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="n">N</span> <span class="o">+</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span> <span class="p">{</span>
        <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">carry</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="m">10000</span> <span class="p">{</span>
            <span class="n">carry</span> <span class="o">=</span> <span class="m">0</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="m">10000</span>
            <span class="n">carry</span> <span class="o">=</span> <span class="m">1</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">sub</span><span class="p">(</span><span class="n">a</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">b</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">c</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">N</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">borrow</span> <span class="o">:=</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="n">N</span> <span class="o">+</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span> <span class="p">{</span>
        <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">borrow</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="p">{</span>
            <span class="n">borrow</span> <span class="o">=</span> <span class="m">0</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="m">10000</span>
            <span class="n">borrow</span> <span class="o">=</span> <span class="m">1</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">div</span><span class="p">(</span><span class="n">a</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">b</span> <span class="kt">int</span><span class="p">,</span> <span class="n">c</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">N</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">remain</span> <span class="o">:=</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="o">+</span><span class="m">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">remain</span>
        <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">/</span> <span class="n">b</span>
        <span class="n">remain</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">%</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="m">10000</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>编译成linux下的程序包，我是在mac上开发的，需要编译到linux下运行，涉及到跨平台编译。</p><p>编译代码命令：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo env GOOS=linux GOARCH=386 go build hpa-test-app.go
</code></pre></div></div><p>如果知道linux系统的准确信息（采用 <code class="language-plaintext highlighter-rouge">uname -a</code> 命令查看），例如amd64或者i386，将上述命令中的 <code class="language-plaintext highlighter-rouge">GOARCH=386</code> 替换为 <code class="language-plaintext highlighter-rouge">GOARCH=amd64</code> 或者 <code class="language-plaintext highlighter-rouge">GOARCH=i386</code></p><p>编译完成后，本地会多出一个 hpa-test-app 程序，备用。</p><p>在hpa-test-app文件夹下，新建Dockerfile文件，内容如下：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM alpine:latest
MAINTAINER YP "yu3peng@qq.com"
WORKDIR $GOPATH/src/github.com/yu3peng/hpa-test-app
ADD hpa-test-app $GOPATH/src/github.com/yu3peng/hpa-test-app
EXPOSE 8080
ENTRYPOINT  ["./hpa-test-app"]
</code></pre></div></div><p>在当前目录下，执行docker build -t hpa-test-app . 输出</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sending build context to Docker daemon  5.12 kB
Step 1/6 : FROM golang:latest
 ---&gt; 2422e4d43e15
Step 2/6 : MAINTAINER YP "yu3peng@qq.com"
 ---&gt; Using cache
 ---&gt; f4a9005be88b
Step 3/6 : WORKDIR $GOPATH/src/github.com/yu3peng
 ---&gt; Using cache
 ---&gt; 6d5fec3b81a1
Step 4/6 : ADD . $GOPATH/src/github.com/yu3peng
 ---&gt; Using cache
 ---&gt; 24b3025ae163
Step 5/6 : EXPOSE 8080
 ---&gt; Using cache
 ---&gt; c2e09786bf15
Step 6/6 : ENTRYPOINT ./hpa-test-app
 ---&gt; Using cache
 ---&gt; b9d6c77740b8
Successfully built b9d6c77740b8
</code></pre></div></div><p>执行docker image ls</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
hpa-test-app        latest              b9d6c77740b8        14 minutes ago      10 MB
</code></pre></div></div><h2 id="服务测试">服务测试</h2><p>基于上面提供的hpa-test-app镜像, 我们创建一个hpa-test-app service, 然后为该service添加HPA机制。</p><h3 id="创建deployment-和-service">创建Deployment 和 service</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~$ kubectl get svc,deploy
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   45d

~$ kubectl run hpa-test-app  --image=yu3peng/hpa-test-app:latest  --requests=cpu=6m,memory=32Mi --limits=cpu=60m,memory=128Mi --expose --port=8080
service "hpa-test-app" created
deployment.apps "hpa-test-app" created
~$ kubectl get svc,deploy
NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/hpa-test-app   ClusterIP   10.105.191.80   &lt;none&gt;        8080/TCP   4s
service/kubernetes     ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP    45d

NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.extensions/hpa-test-app   1         1         1            0           4s
</code></pre></div></div><h3 id="创建hpa">创建HPA</h3><h4 id="基于cpu利用率">基于CPU利用率</h4><p>可以直接使用命令创建HPA</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~$ kubectl autoscale deployment hpa-test-app --cpu-percent=70 --min=1 --max=10
deployment.apps "hpa-test-app" autoscaled
~$ kubectl get hpa
NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
hpa-test-app   Deployment/hpa-test-app   31%/70%   1         10        1          16s
</code></pre></div></div><h4 id="基于memory利用率">基于Memory利用率</h4><p>需要通过配置文件创建</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt; EOF &gt; hpa-test-app-memory-metrics.yaml
apiVersion: autoscaling/v2beta1
kind: HorizontalPodAutoscaler
metadata:
  name: hpa-test-app-memory-metrics
  namespace: default
spec:
  scaleTargetRef:
    apiVersion: extensions/v1beta1
    kind: Deployment
    name: hpa-test-app
  minReplicas: 1
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: memory
      targetAverageValue: 100Mi
EOF
kubectl create -f hpa-test-app-memory-metrics.yaml
</code></pre></div></div><h3 id="增压和减压测试">增压和减压测试</h3><p>首先我们启动一个busybox的pod, 用来对hap-test-app服务进行压力测试</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt; EOF &gt; pod-busybox.yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox
  namespace: default
spec:
  containers:
  - image: busybox
    command:
      - sleep
      - "3600"
    imagePullPolicy: IfNotPresent
    name: busybox
  restartPolicy: Always
EOF
kubectl create -f pod-busybox.yaml
</code></pre></div></div><p>然后我们找到hpa-test-app服务的clusterIP:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~$ kubectl get svc hpa-test-app
NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
hpa-test-app   ClusterIP   10.105.191.80   &lt;none&gt;        8080/TCP   3m
</code></pre></div></div><h4 id="应用扩张">应用扩张</h4><p>进入容器, 持续访问hpa-test-app的API</p><p>默认计算100位的π，用以下命令实现</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it busybox /bin/sh
/ # while true; do wget -q -O- 10.105.191.80:8080; done
</code></pre></div></div><p>如果想加大计算（例如计算1000为的π）可以通过以下命令实现</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it busybox /bin/sh
/ # while true; do wget -q -O- 10.105.191.80:8080/?length=1000; done
</code></pre></div></div><p>然后我们持续关系HPA的扩张</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~$ kubectl get hpa
NAME           REFERENCE                 TARGETS    MINPODS   MAXPODS   REPLICAS   AGE
hpa-test-app   Deployment/hpa-test-app   100%/70%   1         10        1          3m
~$ kubectl get hpa
NAME           REFERENCE                 TARGETS    MINPODS   MAXPODS   REPLICAS   AGE
hpa-test-app   Deployment/hpa-test-app   100%/70%   1         10        2          3m
~$ kubectl get hpa
NAME           REFERENCE                 TARGETS    MINPODS   MAXPODS   REPLICAS   AGE
hpa-test-app   Deployment/hpa-test-app   331%/70%   1         10        2          4m
~$ kubectl get hpa
NAME           REFERENCE                 TARGETS    MINPODS   MAXPODS   REPLICAS   AGE
hpa-test-app   Deployment/hpa-test-app   331%/70%   1         10        5          4m
~$ kubectl get hpa
NAME           REFERENCE                 TARGETS    MINPODS   MAXPODS   REPLICAS   AGE
hpa-test-app   Deployment/hpa-test-app   185%/70%   1         10        8          5m
~$ kubectl get hpa
NAME           REFERENCE                 TARGETS    MINPODS   MAXPODS   REPLICAS   AGE
hpa-test-app   Deployment/hpa-test-app   130%/70%   1         10        10         7m
</code></pre></div></div><p>pod数量的变化情况 1–&gt;2–&gt;5–&gt;8–&gt;10, 最终达到最大的扩展上线而停止。</p><h4 id="应用收缩">应用收缩</h4><p>中断对app的访问, 会发现容器又收缩为原来的1个:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~$ kubectl get hpa
NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
hpa-test-app   Deployment/hpa-test-app   33%/70%   1         10        3          21m
</code></pre></div></div><h2 id="参考资料">参考资料</h2><p>[1] <a href="https://blog.csdn.net/qq_17016649/article/details/79297796">如何利用kubernetes实现应用的水平扩展(HPA)</a></p><p>[2] <a href="https://blog.csdn.net/weixin_39961559/article/details/80578907">k8s controller-manager之hpa源码分析</a></p><p>[3] <a href="http://www.cnblogs.com/cuishuai/p/9857120.html">k8s全栈监控之metrics-server和prometheus</a></p><p>[4] <a href="http://blog.51cto.com/ylw6006/2113848">K8S集群基于heapster的HPA测试</a></p><p>[5] <a href="https://www.yangcs.net/posts/what-happens-when-k8s/">kubectl run 背后到底发生了什么？</a></p><p>[6] <a href="https://blog.csdn.net/kozazyh/article/details/79514742">Kubernetes之kubectl常用命令使用指南:2:故障排查</a></p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://y2p.cc" target="_blank">Yu Peng</a></li><li>本文链接：<a href="https://y2p.cc/2018/12/20/kubernetes-hpa/" target="_blank">https://y2p.cc/2018/12/20/kubernetes-hpa/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"><div class="share-component" data-disabled='qq,facebook'></div></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2018/12/20/kubernetes-hpa/', clientID: 'b2ad054f2e4daf7ad564', clientSecret: 'c742e4086336e58b70e0e88dc791e5bce6e37330', repo: 'blog-comments', owner: 'yu3peng', admin: ['yu3peng'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@built/assets/search_data.json?v=1651905740', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 30, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2022 <span title="Yu Peng">Yu Peng</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/yu3peng/yu3peng.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://y2p.cc/" title="首页" target="">首页</a></li><li> <a href="https://y2p.cc/categories/" title="分类" target="">分类</a></li><li> <a href="https://y2p.cc/notes/" title="笔记" target="">笔记</a></li><li> <a href="https://y2p.cc/about/" title="关于" target="">关于</a></li><li><a href="https://y2p.cc/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/vendor/share.js/dist/js/share.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/yu3peng/yu3peng.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
